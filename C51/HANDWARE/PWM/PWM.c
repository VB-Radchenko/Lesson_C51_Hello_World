
//==============================================================================
//---------------------------------Includes-------------------------------------
//==============================================================================
#include "PWM.h"
#include "UART.h"

//==============================================================================
//---------------------------------Defines--------------------------------------
//==============================================================================

  #define PWM_ACCURACY			0x2042
	#define PWM0_SET_ADDR			0x86
	#define PWM1_SET_ADDR			0x88
  #define PWM0_OUT_ADDR			0x92
  #define PWM1_OUT_ADDR			0x93
	
	
	
	u8 xdata PWM_out[2];
	u8 xdata PWMout[6]={0xaa,0x01,0x20,0x42,0x42};
	u16 PWM_O = 0;
//==============================================================================
//---------------------------------- INIT---------------------------------------
//==============================================================================
void PwmInit(u8 freq)
{

	u8 buff[4] = {0x5A,0x01,(u8)(PWM_ACCURACY>>8),(u8)PWM_ACCURACY};
	
	buff[1] = freq;
	WriteDgusVp(PWM0_SET_ADDR,buff,2);
	PwmSetDuty(100);
}


//==============================================================================
//--------------------------------FUNCTIONS-------------------------------------
//==============================================================================
void PwmSetDuty(u16 duty)
{
	
	u8 PWM[4]={0x5a,0x01,0x20,0x42};
	WriteDgusVp(PWM0_SET_ADDR,PWM,2); 	//ÉèÖÃÔØ²¨ÆµÂÊ
	
	if(duty>100) duty = 100;
		
		PWM[2]= (825753/duty)>>8;
		PWM[3]= (825753/duty);
		WriteDgusVp(PWM0_SET_ADDR,PWM,2); 	//ÉèÖÃÔØ²¨ÆµÂÊ
		WriteDgusVp(PWM1_SET_ADDR,PWM,2); 	//ÉèÖÃÔØ²¨ÆµÂÊ
		//			PWM_Width= ((1000000/PWM_Value)*PWM_Width/100)-900;
			
		PWM_O = (u16)(((float)duty/100.0f) * 8258.0f);
		PWM_out[0] = PWM_O>>8;
		PWM_out[1] = PWM_O;
	
		WriteDgusVp(PWM0_OUT_ADDR,PWM_out,1); 	//ÉèÖÃÔØ²¨ÆµÂÊ
		WriteDgusVp(PWM1_OUT_ADDR,PWM_out,1); 	//ÉèÖÃÔØ²¨ÆµÂÊ
			
	PWMout[1] = PWM_O>>8;
	PWMout[2] = PWM_O;
	PWMout[3] = PWM_O>>8;
	PWMout[4] = PWM_O;
	PWMout[5] = PWM_out[0] + PWM_out[1] + PWM_out[2] + PWM_out[3] + PWM_out[4] ;
	Uatr_Send_Data(3,PWM_out,6);
}



//==============================================================================
//---------------------------------END FILE-------------------------------------
//==============================================================================